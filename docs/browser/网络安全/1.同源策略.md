---
title: 同源策略
createTime: 2026/02/26 12:51:13
permalink: /browser/7u2fqt26/
---

同源策略（SOP）是浏览器安全模型的地基。
如果没有它，任意站点脚本都可以直接读写另一个站点的 DOM 和数据。

![同源策略导图](/browser/source-images/1710914973263-3849cde2-af94-490d-8e44-09f5e32a47ae.jpeg)

## 什么叫“同源”

两个 URL 的 `协议 + 域名 + 端口` 完全一致，才是同源。

:::code-tabs
@tab 同源示例

```txt
https://time.geekbang.org/a
https://time.geekbang.org/b
```

@tab 不同源示例

```txt
http://time.geekbang.org     # 协议不同
https://api.geekbang.org     # 域名不同
https://time.geekbang.org:81 # 端口不同
```
:::

## SOP 约束的三个层面

:::table
| 层面 | 被限制的能力 |
| --- | --- |
| DOM | 不能直接操作跨源页面 DOM |
| 数据 | 不能读取跨源 Cookie / LocalStorage / IndexedDB |
| 网络 | `XHR/Fetch` 默认受跨域策略约束 |
:::

## 为什么还需要“例外机制”

绝对隔离最安全，但 Web 业务需要跨源协作。
所以浏览器提供了“受控放行”的机制，而不是完全放开。

1. `CORS`：服务端声明允许哪些源访问。  
2. `postMessage`：跨文档安全通信。  
3. `CSP`：限制页面可加载和可执行资源。

![恶意脚本注入风险示意](/browser/source-images/1710915978809-017793b4-4bf7-4c68-a6a9-e4992e5144f7.png)

## CORS 的最小理解

浏览器是否放行跨域响应，关键看服务端响应头。

```http
Access-Control-Allow-Origin: https://app.example.com
Access-Control-Allow-Credentials: true
```

如果是“非简单请求”，还会先发预检 `OPTIONS` 请求。

## postMessage 的安全要点

跨源通信不是不能做，而是要做“显式校验”。

```js
window.addEventListener('message', (event) => {
  if (event.origin !== 'https://trusted.example.com') return

  // 只处理可信来源数据
  console.log(event.data)
})
```

## 实战中的一句话原则

同源策略不是障碍，而是默认安全边界。
跨源能力应该通过“白名单 + 最小授权 + 可审计”逐步放开。
