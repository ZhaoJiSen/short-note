---
title: 环境变量与多环境发布
createTime: 2026/02/25 11:38:30
permalink: /engineering/zc6pp6yi/
---

Vite 的环境变量体系核心是“按模式加载 + 前缀暴露控制”。这套机制解决了多环境配置混乱和敏感信息误暴露的问题。

## 环境文件加载规则

Vite 会按 mode 读取对应 `.env` 文件并合并。常见文件组织如下：

:::table full-width
| 文件 | 作用 | 是否建议提交 |
| --- | --- | --- |
| `.env` | 所有模式共享配置 | 是 |
| `.env.local` | 本机私有配置 | 否 |
| `.env.development` | 开发环境配置 | 是 |
| `.env.production` | 生产环境配置 | 是 |
| `.env.[mode].local` | 特定模式下本机私有配置 | 否 |
:::

## 暴露规则：只有 `VITE_` 前缀可进客户端

这是最重要的安全边界。

```bash
# .env.production
VITE_API_BASE=https://api.example.com
VITE_APP_TITLE=My Console
SECRET_KEY=server-only-key
```

```ts
// 客户端代码可访问
console.log(import.meta.env.VITE_API_BASE)

// 这里拿不到 SECRET_KEY
console.log(import.meta.env.SECRET_KEY) // undefined
```

## 在代码中使用环境变量

```ts
if (import.meta.env.DEV) {
  console.log('development mode')
}

if (import.meta.env.PROD) {
  console.log('production mode')
}

const apiBase = import.meta.env.VITE_API_BASE
```

## 在配置文件中按 mode 读取

当你需要在 `vite.config.ts` 里根据 mode 控制代理、base、构建行为时，用 `loadEnv`。

```ts
import { defineConfig, loadEnv } from 'vite'

export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, process.cwd(), '')

  return {
    base: env.VITE_PUBLIC_BASE || '/',
    server: {
      proxy: {
        '/api': {
          target: env.VITE_API_BASE,
          changeOrigin: true,
        },
      },
    },
  }
})
```

## 多环境发布脚本

:::code-tabs
@tab package.json
```json
{
  "scripts": {
    "dev": "vite",
    "build:dev": "vite build --mode development",
    "build:test": "vite build --mode test",
    "build:prod": "vite build --mode production",
    "preview": "vite preview"
  }
}
```

@tab CI 示例
```bash
pnpm install --frozen-lockfile
pnpm run build:prod
```
:::

## 发布建议

::::steps
1. 先定义好环境变量命名规范（前缀、语义、归属）。  
2. 把敏感信息留在服务端，不通过 `VITE_` 暴露。  
3. 每个 mode 对应独立发布流水线，避免“环境串线”。  
4. 通过 `preview` 或灰度环境先验收构建产物。  
::::

:::details 常见误区
1. 把密钥类变量加上 `VITE_` 前缀直接暴露到客户端。  
2. 只在 `.env` 写一份配置，导致多环境发布混用。  
3. 在配置文件中直接用 `process.env`，忽略 mode 维度差异。  
:::
