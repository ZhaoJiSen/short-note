---
title: 中间件
createTime: 2026/01/29 21:41:44
permalink: /vue/ztgntih1/
---

> [!IMPORTANT]
> 本文基于 Nuxt 4（`app/*` 目录结构）
> 路由中间件（Route Middleware）用于在页面导航前执行逻辑，常见用途：
> - 登录校验 / 权限控制
> - 按条件重定向（如未登录跳转登录页）
> - 阻止非法访问并中断导航
> - 统一埋点或导航日志

:::details 最佳实践
1. 中间件保持轻量：只做“是否允许进入页面”的判断，不做重请求。
2. 避免副作用：中间件可能在 SSR + CSR 各执行一次，副作用逻辑要加环境判断。
3. 只用 `to` / `from`：在中间件里优先使用参数，不要依赖 `useRoute()` 当前上下文。
4. 命名清晰：`auth`、`admin` 这类语义化命名更易维护。
5. 有顺序要求就显式控制：全局中间件用前缀（如 `01.`）保证执行顺序。
:::

## 核心概念

### defineNuxtRouteMiddleware

Nuxt 路由中间件通过 `defineNuxtRouteMiddleware` 定义，函数签名如下：

```ts
export default defineNuxtRouteMiddleware((to, from) => {
  // to: 目标路由
  // from: 来源路由
})
```

### 返回值语义

中间件最关键的是“返回什么”：

- 返回 `undefined` / `null` / 不写 `return`：放行，进入下一个中间件或页面
- 返回 `navigateTo('/login')`：重定向到目标页面
- 返回 `abortNavigation()`：中止本次导航
- 返回 `abortNavigation(error)`：中止并抛出错误（可进入错误页）

:::code-tabs
@tab app/middleware/auth.ts
```ts
export default defineNuxtRouteMiddleware((to, from) => {
  const token = useCookie<string | null>('token')

  // 未登录：重定向
  if (!token.value) {
    return navigateTo('/login')
  }

  // 返回空值：放行
  return
})
```
:::

## 三种路由中间件

### 匿名路由中间件（Inline）

匿名中间件通常直接写在页面 `definePageMeta` 里，仅作用于当前页面。

:::code-tabs
@tab app/pages/profile.vue
```vue
<script setup lang="ts">
definePageMeta({
  middleware: [
    (to, from) => {
      // 仅这个页面生效
      if (!to.query.tab) {
        return navigateTo('/profile?tab=base')
      }
    },
  ],
})
</script>
```
:::

### 命名路由中间件（Named）

在 `app/middleware` 中创建文件（如 `auth.ts`），然后在页面中按名称引用。

:::code-tabs
@tab app/middleware/auth.ts
```ts
export default defineNuxtRouteMiddleware(() => {
  const token = useCookie<string | null>('token')
  if (!token.value) {
    return navigateTo('/login')
  }
})
```

@tab app/pages/account.vue
```vue
<script setup lang="ts">
definePageMeta({
  middleware: 'auth',
  // 也可以是数组：middleware: ['auth', 'admin']
})
</script>
```
:::

### 全局路由中间件（Global）

文件名带 `.global.ts` 会在每次路由导航时执行。

:::code-tabs
@tab app/middleware/01.logger.global.ts
```ts
export default defineNuxtRouteMiddleware((to, from) => {
  console.log('[route]', from.fullPath, '->', to.fullPath)
})
```
:::

## 注册与执行顺序

### 自动注册

`app/middleware` 下的中间件会被 Nuxt 自动注册。

::: file-tree
- app
  - middleware
    - auth.ts
    - admin.ts
    - 01.logger.global.ts
    - 02.auth.global.ts
:::

### 执行顺序

1. 先执行全局中间件（`.global.ts`）
2. 再执行页面中声明的中间件（`definePageMeta({ middleware })`）
3. 同一组内按声明顺序执行；全局中间件常用文件名前缀控制顺序

:::code-tabs
@tab app/pages/admin/index.vue
```vue
<script setup lang="ts">
definePageMeta({
  // auth 执行完后再执行 admin
  middleware: ['auth', 'admin'],
})
</script>
```
:::

## 示例：登录校验 + 管理员权限 + 全局日志

::::steps

1. 准备目录

   ::: file-tree
   - app
     - middleware
       - 01.logger.global.ts
       - auth.ts
       - admin.ts
     - pages
       - login.vue
       - admin
         - index.vue
   :::

2. 创建全局日志中间件

   :::code-tabs
   @tab app/middleware/01.logger.global.ts
   ```ts
   export default defineNuxtRouteMiddleware((to, from) => {
     // 所有页面跳转都会经过这里
     console.log('[middleware]', from.fullPath, '->', to.fullPath)
   })
   ```
   :::

3. 创建登录中间件 `auth`

   :::code-tabs
   @tab app/middleware/auth.ts
   ```ts
   export default defineNuxtRouteMiddleware((to) => {
     const token = useCookie<string | null>('token')

     // 避免登录页自身重定向死循环
     if (!token.value && to.path !== '/login') {
       return navigateTo('/login')
     }
   })
   ```
   :::

4. 创建管理员中间件 `admin`

   :::code-tabs
   @tab app/middleware/admin.ts
   ```ts
   export default defineNuxtRouteMiddleware(() => {
     // 示例：真实项目通常来自 user store / 接口返回
     const role = useCookie<'admin' | 'user'>('role')
     if (role.value !== 'admin') {
       // 中断导航并给出错误信息
       return abortNavigation(
         createError({
           statusCode: 403,
           statusMessage: '无权限访问该页面',
         }),
       )
     }
   })
   ```
   :::

5. 在页面声明中间件

   :::code-tabs
   @tab app/pages/admin/index.vue
   ```vue
   <script setup lang="ts">
   definePageMeta({
     // 先验证登录，再校验管理员权限
     middleware: ['auth', 'admin'],
   })
   </script>

   <template>
     <section>Admin Dashboard</section>
   </template>
   ```
   :::
::::

## 动态注册中间件（可选）

有时你想在插件里“运行时注册”中间件，可以用 `addRouteMiddleware`。

:::code-tabs
@tab app/plugins/route-guard.ts
```ts
export default defineNuxtPlugin(() => {
  addRouteMiddleware(
    'audit',
    (to, from) => {
      console.log('[audit]', from.fullPath, '->', to.fullPath)
    },
    { global: true },
  )
})
```
:::

## 与 server/middleware 的区别

很多人会把这两者混淆：

- `app/middleware/*`：路由中间件，运行在 Nuxt 应用导航阶段（页面路由层）
- `server/middleware/*`：Nitro 服务端中间件，运行在每个 HTTP 请求阶段（服务端请求层）

如果你要做“页面访问控制”，用 `app/middleware`；  
如果你要做“服务端请求预处理（如请求头处理）”，用 `server/middleware`。

## 常见错误

### 错误 1：忘记 `return navigateTo(...)`

```ts
// ❌ 错误：没有 return，可能继续执行后续逻辑
if (!token.value) {
  navigateTo('/login')
}
```

```ts
// ✅ 正确
if (!token.value) {
  return navigateTo('/login')
}
```

### 错误 2：在中间件里用当前路由替代 `to`

```ts
// ❌ 不推荐：依赖当前路由上下文
const route = useRoute()
```

```ts
// ✅ 推荐：直接使用 to / from 参数
export default defineNuxtRouteMiddleware((to, from) => {
  console.log(to.path, from.path)
})
```

### 错误 3：重定向死循环

未登录时统一跳 `/login`，但登录页本身也被同一逻辑拦截，导致循环跳转。  
修正：在中间件中放行登录页（如 `to.path !== '/login'` 再重定向）。

### 错误 4：把重逻辑放进中间件

中间件里做大量请求、复杂计算会拖慢导航体验。  
修正：中间件只做“准入判断”，重逻辑放页面或 composable。
