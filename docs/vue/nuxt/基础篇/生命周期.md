---
title: 生命周期
createTime: 2026/01/29 23:09:47
permalink: /vue/tn3accgh/
---

> [!IMPORTANT]
> Nuxt 生命周期由三层组成：**Vue 组件生命周期**、**Nuxt 应用生命周期（hooks）**、**Nitro 服务端生命周期**

:::collapse expand
- 最佳实践

  1. 访问浏览器 API（`window`、`document`、`localStorage`）只放在 `onMounted` 或 `.client.ts`
  2. 避免在 `app:created` 做重任务，放到 `page:finish` 或懒加载逻辑
  3. 需要清理的副作用在 `onUnmounted` 中释放（定时器、事件监听）
  4. 页面级逻辑用 `definePageMeta`，应用级逻辑用插件 `defineNuxtPlugin`
  5. 使用 `useState` 存储全局状态，避免跨请求共享导致 SSR 污染
  6. `app:mounted` 只在客户端触发，服务端不应依赖它

:::

## 核心概念

[+组件生命周期]: Vue 组件的 `setup → onMounted → onUnmounted` 等过程  
[+应用生命周期]: Nuxt 运行时 hooks（`app:created`、`page:finish` 等）  
[+服务端生命周期]: Nitro 处理请求、渲染 HTML、返回响应的过程


Nuxt 的生命周期可分为：组件生命周期[+组件生命周期]、应用生命周期[+应用生命周期]与服务端生命周期[+服务端生命周期]

### 组件生命周期（Vue）

组件生命周期用于管理组件自身状态与副作用，具体可参考 <a href="https://nuxt.com/docs/4.x/api/advanced/hooks#app-hooks-runtime">组件生命周期钩子</a>

```vue
<script setup lang="ts">
import { onMounted, onUnmounted, onServerPrefetch, ref } from 'vue'

const count = ref(0)
let timer: ReturnType<typeof setInterval> | null = null

// 服务端预取数据：只在 SSR 时执行
onServerPrefetch(async () => {
  // 例如：服务端提前拉取数据
})

// 仅客户端执行：适合 DOM 操作与浏览器 API
onMounted(() => {
  timer = setInterval(() => {
    count.value += 1
  }, 1000)
})

// 组件卸载时清理副作用
onUnmounted(() => {
  if (timer) clearInterval(timer)
})
</script>

<template>
  <p>计数器：{{ count }}</p>
</template>
```

### 应用生命周期（Runtime Hooks）

应用生命周期用于全局逻辑，例如埋点、性能统计、统一错误处理等，具体可参考: <a href="https://nuxt.com/docs/4.x/api/advanced/hooks">用生命周期钩子</a>

:::code-tabs
@tab app/plugins/lifecycle.client.ts
```ts
export default defineNuxtPlugin((nuxtApp) => {
  // 应用创建：服务端与客户端都会执行
  nuxtApp.hook('app:created', () => {
    console.log('[app] created')
  })

  // 应用挂载：仅客户端执行
  nuxtApp.hook('app:mounted', () => {
    console.log('[app] mounted')
  })

  // 页面开始切换
  nuxtApp.hook('page:start', () => {
    console.log('[page] start')
  })

  // 页面切换完成
  nuxtApp.hook('page:finish', () => {
    console.log('[page] finish')
  })

  // 全局错误
  nuxtApp.hook('app:error', (error) => {
    console.error('[app] error:', error)
  })
})
```
:::

> [!TIP]
> 在组件中也可以用 `useRuntimeHook` 监听运行时 hooks，更适合页面内局部逻辑。

```vue
<script setup lang="ts">
useRuntimeHook('page:finish', () => {
  console.log('页面已渲染完成')
})
</script>
```

### Nitro 服务端生命周期（Server Hooks）

服务端 hooks 用于请求与响应处理，如注入 HTML、统计访问等，具体可以参考 <a href="https://nuxt.com/docs/4.x/api/advanced/hooks#nitro-app-hooks-runtime-server-side">服务端生命周期钩子</a>

:::code-tabs
@tab server/plugins/server-hooks.ts
```ts
export default defineNitroPlugin((nitroApp) => {
  // 请求进入
  nitroApp.hooks.hook('request', (event) => {
    console.log('[server] request:', event.path)
  })

  // 修改 HTML 输出
  nitroApp.hooks.hook('render:html', (html) => {
    html.head.push('<meta name="app" content="short-note">')
  })

  // 响应结束
  nitroApp.hooks.hook('afterResponse', (event) => {
    console.log('[server] done:', event.path)
  })
})
```
:::

### 构建期 Hooks（nuxt.config.ts）

构建期 hooks 用于扩展构建流程与目录扫描等行为，通常在 `nuxt.config.ts` 中进行配置

```ts
export default defineNuxtConfig({
  hooks: {
    'build:before': () => {
      console.log('Build start')
    },
    'components:dirs': (dirs) => {
      // 扩展组件目录
      dirs.push({ path: '~/extra-components' })
    },
  },
})
```

## SSR 与 CSR 的执行差异

- **服务端**：执行 `setup`、`onServerPrefetch`，完成 SSR 渲染并返回 HTML
- **客户端**：进行 Hydration，再触发 `onMounted` 等浏览器生命周期
- **结论**：`setup` 会在服务端与客户端都执行，必须保证无浏览器依赖


## 示例：页面性能统计

::::steps

1. 准备目录结构

   ::: file-tree
   - app
     - plugins
       - perf.client.ts
     - composables
       - usePagePerf.ts
     - pages
       - index.vue
   :::

2. 插件监听页面切换生命周期

   :::code-tabs
   @tab app/plugins/perf.client.ts
   ```ts
   export default defineNuxtPlugin((nuxtApp) => {
     // 用 useState 避免 SSR 跨请求污染
     const perf = useState('page-perf', () => ({ start: 0, duration: 0 }))

     nuxtApp.hook('page:start', () => {
       perf.value.start = performance.now()
     })

     nuxtApp.hook('page:finish', () => {
       perf.value.duration = Math.round(performance.now() - perf.value.start)
     })
   })
   ```
   :::

3. 抽成 composable 供页面读取

   :::code-tabs
   @tab app/composables/usePagePerf.ts
   ```ts
   export function usePagePerf() {
     return useState('page-perf', () => ({ start: 0, duration: 0 }))
   }
   ```
   :::

4. 页面展示耗时结果

   :::code-tabs
   @tab app/pages/index.vue
   ```vue
   <script setup lang="ts">
   const perf = usePagePerf()
   </script>

   <template>
     <section>
       <h1>首页</h1>
       <p>最近一次页面切换耗时：{{ perf.duration }} ms</p>
     </section>
   </template>
   ```
   :::
::::
